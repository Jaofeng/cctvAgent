/* RTSP Streaming over WebSocket v1.0.0 by Chen Jaofeng */
"use strict";!function(){var e=/::(\d{1,})::/,o=/~(\d{1,})~/,t=!1,n=[],r={};function s(e){var o=$(e);return n.find(e=>$(e.target).is(o))}r.connectTo=function(c,i,a,u=0,l=0){var f=$(c),d=n.findIndex(e=>$(e.target).is(f));-1!=d&&(void 0!==n[d].socket&&null!=n[d].socket&&n[d].socket.close(),n.splice(d,1)),n.push(function(n,c,i,a,u){var l=s(n);if(void 0!==l)return l;l={socket:null,err:0,packages:0,buffer:[],host:c,target:$(n),rtsp:i,resolution:[a,u]};try{var f=new WebSocket("ws://"+c);l.socket=f,f.onopen=function(e){console.log("WebSocket opened"),f.send(JSON.stringify({act:"open",url:i,resolution:l.resolution}))},f.onmessage=function(t){if(void 0!==t&&void 0!==t.data)try{if(null!=(n=t.data.match(e)))l.packages=parseInt(n[1]),l.buffer=[];else{var n;if(null==(n=t.data.match(o)))return;var r=parseInt(n[1]);l.buffer[r-1]=t.data.substr(n[0].length),r==l.packages&&($(l.target).attr("src",l.buffer.join("")),l.buffer=[])}l.err=0}catch(e){console.log("onmessage error: "+e)}},f.onerror=function(e){},f.onclose=function(e){console.log("WebSocket closed"),l.socket=null,l.err++;var o=l.err>100?5e3:1;t||setTimeout(function(){r.connectTo(n,c,i,a,u)},o)}}catch(e){return console.error(e),null}return l.socket=f,l}(c,i,a,u,l))},r.stop=function(){t=!0,n.forEach(e=>e.socket.close()),n.splice(0,n.length)},r.find=s,r.resize=function(e,o,t){var n=s(e);if(void 0!==n&&(n.resolution=[o,t],null!=n.socket))try{n.socket.send(JSON.stringify({act:"resize",resolution:n.resolution}))}catch(e){console.error(e)}},window.rtspProxy=r}(),$(window).on("beforeunload",function(){rtspProxy.stop()});